name: deploy

on:
  push:
    branches:
      - "main"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      IMAGE: ghcr.io/azenith-solutions/order-microservice-api
      TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.IMAGE }}:${{ env.TAG }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci

          ssh-keyscan -T 10 -H "${{ secrets.BASTION_IP }}" >> ~/.ssh/known_hosts

          cat > ~/.ssh/config << 'EOF'
          Host bastion
            HostName ${{ secrets.BASTION_IP }}
            User deploy
            IdentityFile ~/.ssh/id_ci
            StrictHostKeyChecking no
          EOF

          chmod 600 ~/.ssh/config

      - name: Configure SSH keys in bastion
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | ssh bastion 'cat > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa'

          ssh bastion 'cat > ~/.ssh/config << "SSHCONFIG"
          Host target-backend-1
            HostName ${{ secrets.BACKEND_SERVER_1_IP }}
            User deploy
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no

          Host target-backend-2
            HostName ${{ secrets.BACKEND_SERVER_2_IP }}
            User deploy
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
          SSHCONFIG'

          ssh bastion 'chmod 600 ~/.ssh/config'

      - name: Copy docker-compose.yaml
        run: |
          scp ./docker-compose.yaml bastion:/tmp/docker-compose.yaml
          ssh bastion "scp /tmp/docker-compose.yaml target-backend-1:/opt/backend-api-rest/"
          ssh bastion "scp /tmp/docker-compose.yaml target-backend-2:/opt/backend-api-rest/"

      - name: Deploy to servers
        run: |
          DEPLOY_SCRIPT='
            set -e
            cd /opt/backend-api-rest
            
            if [ ! -f .env.production ]; then
              echo "❌ Erro: .env.production não existe!"
              exit 1
            fi
            
            echo "=== Configurando variáveis de ambiente ==="
            echo "BACKEND_IMAGE_TAG=latest" > .env
            echo "ORDER_IMAGE_TAG=${{ github.sha }}" >> .env
            cat .env.production >> .env
            
            echo "=== Fazendo login no Docker Registry ==="
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            
            echo "=== Fazendo pull da nova imagem ==="
            docker compose --env-file .env pull order-microservice
            
            echo "=== Iniciando o serviço ==="
            docker compose --env-file .env up -d order-microservice
            
            echo "=== Aguardando inicialização ==="
            sleep 15
            
            echo "=== Status dos containers ==="
            docker compose ps
          '

          echo "Deploying to server 1..."
          ssh bastion "ssh target-backend-1 '$DEPLOY_SCRIPT'"

          echo "Deploying to server 2..."
          ssh bastion "ssh target-backend-2 '$DEPLOY_SCRIPT'"

      - name: Health Check
        run: |
          echo "=== Health Check ==="
          sleep 30

          echo "Checking server 1..."
          ssh bastion "ssh target-backend-1 'curl -f http://localhost:8082/actuator/health'"

          echo "Checking server 2..."
          ssh bastion "ssh target-backend-2 'curl -f http://localhost:8082/actuator/health'"

          echo "✅ Deploy completed successfully!"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_ci
          echo "✅ Cleanup completed!"
